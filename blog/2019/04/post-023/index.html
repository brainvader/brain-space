<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Test Site - Rust入門 (2) テスト</title>

    
          
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">

          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
          <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/mathtex-script-type.min.js" integrity="sha384-zWYbd0NBwgTsgIdFKVprSfTh1mbMPe5Hz1X3yY4Sd1h/K1cQoUe36OGwAGz/PcDy" crossorigin="anonymous"></script>
              
              <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
                  onload="renderMathInElement(document.body);"></script>
              
          
    

    
    <link rel="stylesheet" href="https:&#x2f;&#x2f;brainvader.github.io&#x2f;brain-space&#x2f;css&#x2f;base.css">
    
  </head>

  <body>
    <div class="container">
      <header id="header">
        <!-- TODO:  Use a tags instead of ul -->
        <div class="logo"><a href="https:&#x2f;&#x2f;brainvader.github.io&#x2f;brain-space&#x2f;">Brain Space</a></div>
        <nav class="menu">
          <ul>
            
            <li>
              <a href="https://brainvader.github.io/brain-space/">
                Home
              </a>
            </li>
            
            <li>
              <a href="https://brainvader.github.io/brain-space/&#x2f;categories">
                Categories
              </a>
            </li>
            
            <li>
              <a href="https://brainvader.github.io/brain-space/&#x2f;tags">
                Tags
              </a>
            </li>
            
            <li>
              <a href="https://brainvader.github.io/brain-space/&#x2f;about">
                About
              </a>
            </li>
            
          </ul>
        </nav>
      </header>
      <main>
        <div class="content">
          


<div>blog&#x2f;2019&#x2f;04&#x2f;post-023&#x2f;</div>
<div>https:&#x2f;&#x2f;brainvader.github.io&#x2f;brain-space&#x2f;blog&#x2f;2019&#x2f;04&#x2f;post-023&#x2f;</div>
<div>en</div>
<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#rustru-men-2" class="toc-link">Rust入門 (2)</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#qian-ti-tiao-jian" class="toc-link">前提条件</a>
                        </li>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#dan-ti-tesuto" class="toc-link">単体テスト</a>
                        </li>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#jie-he-tesuto" class="toc-link">結合テスト</a>
                        </li>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#dev-dependencies" class="toc-link">dev-dependencies</a>
                        </li>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#dokiyumentesiyontesuto" class="toc-link">ドキュメンテーション・テスト</a>
                        </li>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#panitukutesuto" class="toc-link">パニック・テスト</a>
                        </li>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#tesutowozhi-ding-siteshi-xing" class="toc-link">テストを指定して実行</a>
                        </li>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#tesutowochu-wai-suru" class="toc-link">テストを除外する</a>
                        </li>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#makuro" class="toc-link">マクロ</a>
                        </li>
                        
                        <li>
                            <a href="https://brainvader.github.io/brain-space/blog/2019/04/post-023/#reference" class="toc-link">Reference</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
<header class="post__header">
  <h1 class="post__title">
    <a href="https:&#x2f;&#x2f;brainvader.github.io&#x2f;brain-space&#x2f;blog&#x2f;2019&#x2f;04&#x2f;post-023&#x2f;">Rust入門 (2) テスト</a>
  </h1>
  <div class="post__meta">
    <span class="post__time">2019-04-27</span>
    
  </div>
</header>

    <div class="post-content">
      <h1 id="rustru-men-2">Rust入門 (2)</h1>
<h2 id="qian-ti-tiao-jian">前提条件</h2>
<p>　プロジェクトはlibraryとして生成します. プロジェクト名はgeometryとします(特に意味はないです).</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">cargo new geometry --lib
</span></pre>
<p>　ライブラリとしてプロジェクトを生成すると勝手にテストの雛形が生成されますので, 後はコマンド一発でテストが実行できます.</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">cargo</span><span style="color:#c0c5ce;"> test
</span></pre><h2 id="dan-ti-tesuto">単体テスト</h2>
<p>　Cargoが自動で生成するテスト内容はこんな感じになります.</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#[</span><span style="color:#bf616a;">cfg</span><span style="color:#c0c5ce;">(test)]
</span><span style="color:#b48ead;">mod </span><span style="color:#c0c5ce;">tests {
    #[</span><span style="color:#bf616a;">test</span><span style="color:#c0c5ce;">]
    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">it_works</span><span style="color:#c0c5ce;">() {
        assert_eq!(</span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">+ </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">);
    }
}
</span></pre>
<p>　#[cfg(test)]属性をつけてtestsモジュール以下にテストを記述します. #[test]属性がついた関数をテストと認識します. では実際に関数を定義してテストしてみましょう.</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">add</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">a</span><span style="color:#c0c5ce;">: </span><span style="color:#b48ead;">i32</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">b</span><span style="color:#c0c5ce;">: </span><span style="color:#b48ead;">i32</span><span style="color:#c0c5ce;">) -&gt; </span><span style="color:#b48ead;">i32 </span><span style="color:#c0c5ce;">{
    a + b
}

#[</span><span style="color:#bf616a;">cfg</span><span style="color:#c0c5ce;">(test)]
</span><span style="color:#b48ead;">mod </span><span style="color:#c0c5ce;">tests {
    </span><span style="color:#b48ead;">use super</span><span style="color:#c0c5ce;">::*;

    #[</span><span style="color:#bf616a;">test</span><span style="color:#c0c5ce;">]
    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test_add</span><span style="color:#c0c5ce;">() {
        assert_eq!(</span><span style="color:#96b5b4;">add</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">), </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">);
    }

    #[</span><span style="color:#bf616a;">allow</span><span style="color:#c0c5ce;">(dead_code)] </span><span style="color:#65737e;">// to remove an unused-code warning
    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">no_test</span><span style="color:#c0c5ce;">() {
        assert_eq!(</span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">+ </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">);
    }
}
</span></pre>
<p>　addというなんの変哲も無い関数を定義してテストしますが, 失敗するはずです. useは外側の名前を取り込むための行です. もう一つのno_testは#[test]属性がついていないので, ただの関数定義ですので実行されません(#[allow(dead_code)]属性はunused codeの警告を消すため).</p>
<h2 id="jie-he-tesuto">結合テスト</h2>
<p>　今度は結合テストを行います. プロジェクト直下にtestsというフォルダを作り, 以下のファイルを保存します.</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// integratin_test.rs
</span><span style="color:#b48ead;">extern crate</span><span style="color:#c0c5ce;"> geometry;  </span><span style="color:#65737e;">// your project name by defaul
</span><span style="color:#b48ead;">use </span><span style="color:#c0c5ce;">geometry::*;

#[</span><span style="color:#bf616a;">test</span><span style="color:#c0c5ce;">]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test_add</span><span style="color:#c0c5ce;">() {
    assert_eq!(</span><span style="color:#96b5b4;">add</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">), </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">);
}
</span></pre>
<p>　なおtestsフォルダ以下のファイルは別々のクレートとして実行されます. テスト共通の処理などを記述したい場合はtestsフォルダ内に記述します. testスイートなどのsetupとかteardownを書けばいいのかもしれません. モジュールの扱い方の復習もかねて書いておきましょう.</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// common.rs
</span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">setup</span><span style="color:#c0c5ce;">() {
    </span><span style="color:#65737e;">// some setup code, like creating required files/directories, starting
    // servers, etc.
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>　モジュールにしたい場合は, 適当なフォルダ(ここではsharedとする)以下に以下のようなファイルを配置します.</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// mod.rs
</span><span style="color:#b48ead;">pub mod </span><span style="color:#c0c5ce;">shared;
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#65737e;">// shaerd.rs
</span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">teardown</span><span style="color:#c0c5ce;">() {
  println!(&quot;</span><span style="color:#a3be8c;">called `shared::function()`</span><span style="color:#c0c5ce;">&quot;);
}
</span></pre>
<p>　後はintegration_test.rsで呼び出すだけです.</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">extern crate</span><span style="color:#c0c5ce;"> geometry;
</span><span style="color:#b48ead;">use </span><span style="color:#c0c5ce;">geometry::*;

</span><span style="color:#b48ead;">mod </span><span style="color:#c0c5ce;">common;
</span><span style="color:#b48ead;">mod </span><span style="color:#c0c5ce;">shared;
</span><span style="color:#b48ead;">use </span><span style="color:#c0c5ce;">shared::shared::*;

#[</span><span style="color:#bf616a;">test</span><span style="color:#c0c5ce;">]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test_add</span><span style="color:#c0c5ce;">() {
    common::setup();
    assert_eq!(</span><span style="color:#96b5b4;">add</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">), </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">);
    </span><span style="color:#96b5b4;">teardown</span><span style="color:#c0c5ce;">();
}
</span></pre>
<p>　ちょっと変な書き方ですが色々なやり方が網羅できたと思います.</p>
<h2 id="dev-dependencies">dev-dependencies</h2>
<p>　テスト用の依存性はdev-dependenciesセクションに記述します.</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">[dev-dependencies]
</span><span style="color:#bf616a;">pretty_assertions </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">0.4.0</span><span style="color:#c0c5ce;">&quot;
</span></pre>
<p>　このクレートを#[cfg(test)]属性以下で導入します.</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#[</span><span style="color:#bf616a;">cfg</span><span style="color:#c0c5ce;">(test)]
</span><span style="color:#b48ead;">extern crate</span><span style="color:#c0c5ce;"> pretty_assertions
</span></pre>
<p>　こんな感じで外部のクレートを使ったテストも実行できます.</p>
<h2 id="dokiyumentesiyontesuto">ドキュメンテーション・テスト</h2>
<p>　ドキュメントにコードを書くとテストしてくれるやつです. ドキュメントはMarkdownで書けるらしいです.</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/// The next lines present detailed documentation. Code blocks start with
/// triple backquotes and have implicit `fn main()` inside
/// and `extern crate &lt;cratename&gt;`. Assume we&#39;re testing `doccomments` crate:
///
/// ```
/// use geometry::add;
/// let result = add(2, 3);
/// assert_eq!(result, 5);
/// ```

</span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">add</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">a</span><span style="color:#c0c5ce;">: </span><span style="color:#b48ead;">i32</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">b</span><span style="color:#c0c5ce;">: </span><span style="color:#b48ead;">i32</span><span style="color:#c0c5ce;">) -&gt; </span><span style="color:#b48ead;">i32 </span><span style="color:#c0c5ce;">{
    a + b
}
</span></pre><h2 id="panitukutesuto">パニック・テスト</h2>
<p>　パニックになることをテストしたい場合があります. 例としてゼロ除算でパニックが起こることをテストしましょう.</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">divide</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">numerator</span><span style="color:#c0c5ce;">: </span><span style="color:#b48ead;">u32</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">denominator</span><span style="color:#c0c5ce;">: </span><span style="color:#b48ead;">u32</span><span style="color:#c0c5ce;">) -&gt; </span><span style="color:#b48ead;">u32 </span><span style="color:#c0c5ce;">{
    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> denominator == </span><span style="color:#d08770;">0 </span><span style="color:#c0c5ce;">{
        panic!(&quot;</span><span style="color:#a3be8c;">Divide-by-zero error</span><span style="color:#c0c5ce;">&quot;);
    } </span><span style="color:#b48ead;">else if</span><span style="color:#c0c5ce;"> numerator &lt; denominator {
        panic!(&quot;</span><span style="color:#a3be8c;">Divide result is zero</span><span style="color:#c0c5ce;">&quot;);
    }
    numerator / denominator
}
</span></pre>
<p>　後は単体テストと同じようにテストを追加すればいいのですが, その際#[should_panic]属性を追加します. これでパニックがおきた場合にテストが通ります. なおexpectedパラメータにはpanicマクロに与えるメッセージと同じものを指定します. これはテスト失敗がきちんと想定した場所で起きていることを確かめるのに使えるそうです.</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#[</span><span style="color:#bf616a;">test</span><span style="color:#c0c5ce;">]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test_divide</span><span style="color:#c0c5ce;">() {
    assert_eq!(</span><span style="color:#96b5b4;">divide</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">), </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">);
}

#[</span><span style="color:#bf616a;">test</span><span style="color:#c0c5ce;">]
#[</span><span style="color:#bf616a;">should_panic</span><span style="color:#c0c5ce;">]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test_divide_by_zero</span><span style="color:#c0c5ce;">() {
    </span><span style="color:#96b5b4;">divide</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);
}

#[</span><span style="color:#bf616a;">test</span><span style="color:#c0c5ce;">]
#[</span><span style="color:#bf616a;">should_panic</span><span style="color:#c0c5ce;">(expected = &quot;</span><span style="color:#a3be8c;">Divide result is zero</span><span style="color:#c0c5ce;">&quot;)]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">test_devided_by_larger_denominator</span><span style="color:#c0c5ce;">() {
    </span><span style="color:#96b5b4;">divide</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">);
}
</span></pre><h2 id="tesutowozhi-ding-siteshi-xing">テストを指定して実行</h2>
<p>　テスト名を指定して実行することもできます.</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">cargo</span><span style="color:#c0c5ce;"> test test_name
</span></pre><h2 id="tesutowochu-wai-suru">テストを除外する</h2>
<p>　テストから除外するにはignore属性を利用します.
　</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#[</span><span style="color:#bf616a;">ignore</span><span style="color:#c0c5ce;">]
</span></pre>
<p>　除外したテストをのみを実行する場合はignoreオプションを使います.</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">cargo</span><span style="color:#c0c5ce;"> run -- --ignored
</span></pre><h2 id="makuro">マクロ</h2>
<p>　
　マクロを列挙する予定.</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://doc.rust-lang.org/rust-by-example/testing.html#testing">Testing on Rust By Example</a></li>
<li><a href="https://doc.rust-lang.org/cargo/reference/manifest.html#tests">Tests on Cargo Book</a></li>
<li><a href="https://doc.rust-lang.org/book/ch11-00-testing.html">Writing Automated Tests on The Rust Programming Language</a></li>
<li><a href="https://doc.rust-jp.rs/the-rust-programming-language-ja/1.6/book/testing.html">テスト プログラミング言語Rust</a></li>
<li><a href="https://doc.rust-lang.org/rustdoc/what-is-rustdoc.html">What is rustdoc?</a></li>
</ul>

    </div>

    
    

    <div class="post-footer">
        
        
          key: kind, value [object]<br>
        
          key: items, value [[object], [object], [object], [object]]<br>
        
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2f;&#x2f;brainvader.github.io&#x2f;brain-space&#x2f;tags&#x2f;rust&#x2f;">#Rust</a>
                    
                </div>
            
            

        

    </div>

    
    
</article>


        </div>
      </main>
      <footer>
        
        <nav class="pagination">
          
          
        </nav>
        
      </footer>
    </div>
  </body>

</html>
